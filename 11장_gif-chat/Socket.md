---


---

<h1 id="웹-소켓-이해하기">11.1 웹 소켓 이해하기</h1>
<p>웹 소켓이란 HTML5에서 추가된 스펙으로, HTTP프로토콜이 아닌 <strong>WS</strong>프로토콜을 사용한다.<br>
처음 웹 소켓 연결이 이루어지고 나면, 그 다음부터는 계속 연결된 상태로 있기 때문에 폴링 방식과 다르게 업데이트가 있는지 요청을 보낼 필요가 없다.<br>
<strong>서버센트 이벤트(SSE)</strong> 라는 기능도 있다. <em>EventSource</em>라는 객체를 사용하여 서버가 클라이언트에 지속적으로 이벤트를 보낼 수 있게 했다.<br>
웹 소켓과 다른 점으로는, 클라이언트에서 서버로는 데이터를 보낼 수 없는 서버&gt;클라이언트 단방향 통신이라는 점이다.</p>
<p>따라서 그냥 웹 소켓을 이용하면 SSE의 모든 기능들을 구현할 수 있지만, SNS게시글 가져오기 같은 양방향 통신이 필요 없는 기술들에는 SSE를 사용하기도 한다.</p>
<h1 id="ws모듈로-웹-소켓-사용하기">11.2 ws모듈로 웹 소켓 사용하기</h1>
<blockquote>
<p>socket.js</p>
</blockquote>
<p>HTTP 프로토콜과 WS 프로토콜은 같은 포트를 공유할 수 있으므로 별도의 작업이 필요하지는 않다.<br>
또한 연결 및 통신, 해제 시에 ip주소가 필요하지는 않지만, 서버 로그의 목적으로 클라이언트의 ip를 알아내고자 할 떄는</p>
<pre><code>req.headres['x-forworded-for'] || req.connection.remoteAddress
</code></pre>
<p>을 사용하여 알아낼 수 있다.<br>
익스프레스에서는 ip를 확인할 때, proxy-addr 패키지를 사용하므로, 이 패키지를 사용해도 된다.<br>
익스프레스 서버와 연결한 후, 웹 소켓 객체(ws)에 세 개의 이벤트 리스너를 넣어두었다.</p>
<ul>
<li>message : 클라이언트로부터 메시지가 왔을 때 발생</li>
<li>error : 웹 소켓 연결 중 문제가 생겼을 때 발생</li>
<li>close : 클라이언트와 연결이 끊겼을 때 발생</li>
</ul>
<p><em>setInterval</em> 은 3초마다 연결된 모든 클라이언트에게 메시지를 보내는 부분이다. 먼저 readyState로 소켓이 OPEN 상태인지 확인한다.<br>
소켓에는 CONNECTING(연결 중), OPEN(열림), CLOSING(닫는 중), CLOSED(닫힘) 의 네 가지 상태가 있다.<br>
OPEN일 때만 에러 없이 메시지를 보낼 수 있다.</p>
<p>close 이벤트에서 setInterval을 clearInterval로 정리해야 한다. 이 부분이 없으면 메모리 누수가 발생한다.</p>

